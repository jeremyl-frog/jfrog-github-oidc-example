name: "JFrog-GitHub OIDC POC via REST"
on:
  workflow_dispatch:

permissions:
  id-token: write

jobs:
  build:
    runs-on: self-hosted
    env:
      OIDC_TOKEN_PATH: ${{ secrets.OIDC_TOKEN_PATH }}
      OIDC_AUDIENCE: 'frog-company'         # must match your JFrog OIDC audience
      OIDC_PROVIDER: 'jeremyl-frog'         # must match the provider configured in JFrog
      JF_URL: ${{ secrets.CLOUD_JF_URL }}   # GitHub Actions secret for your JFrog base URL
      JF_REPO: 'jl-ci-releases'             # your Artifactory repo key
      TOKEN_PAYLOAD_PATH: ${{ secrets.ACCESS_TOKEN_PAYLOAD_PATH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get and inspect GitHub OIDC token
        run: |
          # Fetch GitHub OIDC token from GitHub’s OIDC endpoint
          ID_TOKEN=$(curl -sLS \
            -H "User-Agent: actions/oidc-client" \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=$OIDC_AUDIENCE" \
            | jq -r .value)
            
          # Print token for immediate testing in the Token Exchange API          
          echo "Token String > $OIDC_TOKEN_PATH"
          echo "$ID_TOKEN printed to sandbox" 
          echo "ID_TOKEN=$ID_TOKEN" >> $GITHUB_ENV

          # Decode JWT payload to inspect claims
          PAYLOAD=$(echo "$ID_TOKEN" \
            | cut -d '.' -f2 \
            | tr '_-' '/+' \
            | awk '{ l=length($0)%4; if (l>0) print $0 substr("====",1,4-l); else print $0; }' \
            | base64 -D \
            | jq .)

          echo "Decoded OIDC claims:"
          echo "$PAYLOAD"

      - name: Exchange OIDC token for JFrog access token
        env:
          ID_TOKEN: ${{ env.ID_TOKEN }}
        run: |
          RESPONSE=$(curl -sLS -X POST "$JF_URL/access/api/v1/oidc/token" \
            -H "Content-Type: application/json" \
            -d "{
              \"grant_type\": \"urn:ietf:params:oauth:grant-type:token-exchange\",
              \"subject_token_type\": \"urn:ietf:params:oauth:token-type:id_token\",
              \"subject_token\": \"$ID_TOKEN\",
              \"provider_name\": \"$OIDC_PROVIDER\"
            }")

          ACCESS_TOKEN=$(echo "$RESPONSE" | jq -r '.access_token // empty')

          if [ -z "$ACCESS_TOKEN" ]; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.errors[0].message // "Unknown error"')
            echo "❌ Failed to obtain access token: $ERROR_MSG"
            echo "Full response from Artifactory:"
            echo "$RESPONSE"
            exit 1
          fi

          # --- Decode JWT payload ---
          decode_base64url() { echo "$1" | tr '_-' '/+' | awk '{l=length($0)%4; if(l>0) print $0 substr("====",1,4-l); else print $0}' | base64 -D 2>/dev/null; }
          PAYLOAD=$(echo "$ACCESS_TOKEN" | cut -d '.' -f2)
          DECODED_PAYLOAD=$(decode_base64url "$PAYLOAD" | jq .)

          echo "$DECODED_PAYLOAD" > $TOKEN_PAYLOAD_PATH
          echo "Decoded access token written to sandbox/access-token-decoded.txt"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$ACCESS_TOKEN"

      - name: Create dummy artifact
        run: echo "hello jfrog" > oidc-poc

      - name: Deploy to Artifactory
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
        run: |
          curl -sLS \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -T oidc-poc \
            "$JF_URL/artifactory/$JF_REPO/oidc-poc-$(date +%Y%m%d%H%M%S)"
            
